<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>单词学习 - 智能翻译助手</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='vocabulary.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 主题预加载脚本 - 避免主题闪烁 -->
    <script>
        (function() {
            // 在DOM渲染前应用保存的主题
            const savedTheme = localStorage.getItem('theme') || 'harajuku';
            const root = document.documentElement;
            
            // 先清除所有主题类
            root.classList.remove('pixel-theme', 'cyberpunk-theme');
            
            // 应用保存的主题
            if (savedTheme === 'pixel') {
                root.classList.add('pixel-theme');
            } else if (savedTheme === 'cyberpunk') {
                root.classList.add('cyberpunk-theme');
            }
        })();
    </script>
</head>
<body>
    <!-- 主题切换按钮 -->
    <button id="themeToggle" class="theme-toggle">
        <span class="icon">🎨</span>
        <span class="text">主题</span>
    </button>
    
    <!-- 主题选择下拉菜单 -->
    <div id="themeMenu" class="theme-menu">
        <div class="theme-option" data-theme="harajuku">
            <span class="theme-option-icon">🌸</span>
            <span class="theme-option-name">原宿风</span>
        </div>
        <div class="theme-option" data-theme="pixel">
            <span class="theme-option-icon">🎮</span>
            <span class="theme-option-name">像素风</span>
        </div>
        <div class="theme-option" data-theme="cyberpunk">
            <span class="theme-option-icon">🌃</span>
            <span class="theme-option-name">未来朋克</span>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="title-container">
                <h1 class="title">单词学习</h1>
                <p class="subtitle">英语词汇库</p>
            </div>
            <nav class="nav-links">
                <a href="/" class="nav-link">返回翻译</a>
            </nav>
        </header>

        <div class="search-section">
            <input type="text" id="searchInput" class="search-input" placeholder="搜索单词或中文含义...">
            <div class="search-options">
                <label class="case-sensitive-label">
                    <input type="checkbox" id="caseSensitiveCheckbox">
                    <span class="checkbox-text">区分大小写</span>
                </label>
            </div>
            <button id="searchBtn" class="action-btn">搜索</button>
            <button id="randomBtn" class="action-btn">随机50个</button>
        </div>

        <div class="vocabulary-container">
            <div id="wordList" class="word-list">
                <!-- 单词卡片将通过JavaScript动态添加 -->
            </div>
            
            <!-- 添加新单词的弹窗 -->
            <div id="addWordModal" class="add-word-modal">
                <div class="add-word-content">
                    <span class="close-modal">&times;</span>
                    <h3>添加新单词</h3>
                    <p id="modalMessage">未找到单词"<span id="searchedWord"></span>"，是否添加到单词库？</p>
                    <div class="form-group">
                        <label for="wordInput">单词:</label>
                        <input type="text" id="wordInput" class="modal-input" autocomplete="off">
                    </div>
                    <div class="form-group">
                        <label for="translationInput">翻译 (词性.含义):</label>
                        <input type="text" id="translationInput" class="modal-input" placeholder="例如: n.苹果 或 v.跑" autocomplete="off">
                        <small class="input-tip">提示: 输入词性后加点，如"n."表示名词，"v."表示动词</small>
                    </div>
                    <div class="modal-buttons">
                        <button id="addWordBtn" class="action-btn">添加单词</button>
                        <button id="cancelAddBtn" class="cancel-btn">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let allWords = []; // 存储所有单词
            let shownWords = []; // 存储已经展示过的单词的ID
            let currentDisplayedWords = []; // 当前显示的50个单词
            let isThemeMenuOpen = false;
            
            // 主题切换功能
            const themeToggle = document.getElementById('themeToggle');
            const themeMenu = document.getElementById('themeMenu');
            const themeOptions = document.querySelectorAll('.theme-option');
            
            // 应用保存的主题
            function applyTheme() {
                const savedTheme = localStorage.getItem('theme') || 'harajuku';
                const root = document.documentElement;
                
                // 移除所有主题类
                root.classList.remove('pixel-theme', 'cyberpunk-theme');
                
                // 应用保存的主题
                if (savedTheme === 'pixel') {
                    root.classList.add('pixel-theme');
                } else if (savedTheme === 'cyberpunk') {
                    root.classList.add('cyberpunk-theme');
                }
                
                // 更新主题选项的选中状态
                themeOptions.forEach(option => {
                    if (option.dataset.theme === savedTheme) {
                        option.classList.add('active');
                    } else {
                        option.classList.remove('active');
                    }
                });
            }
            
            // 应用主题（在DOM加载完成后立即执行）
            applyTheme();
            
            // 主题菜单显示/隐藏功能
            themeToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                
                if (isThemeMenuOpen) {
                    themeMenu.classList.remove('active');
                } else {
                    themeMenu.classList.add('active');
                }
                
                isThemeMenuOpen = !isThemeMenuOpen;
            });
            
            // 点击文档其他地方关闭主题菜单
            document.addEventListener('click', function() {
                if (isThemeMenuOpen) {
                    themeMenu.classList.remove('active');
                    isThemeMenuOpen = false;
                }
            });
            
            // 阻止菜单内的点击事件冒泡到文档
            themeMenu.addEventListener('click', function(e) {
                e.stopPropagation();
            });
            
            // 主题选项点击事件
            themeOptions.forEach(option => {
                option.addEventListener('click', function() {
                    const theme = this.dataset.theme;
                    const root = document.documentElement;
                    
                    // 移除所有主题类
                    root.classList.remove('pixel-theme', 'cyberpunk-theme');
                    
                    // 应用选择的主题
                    if (theme === 'pixel') {
                        root.classList.add('pixel-theme');
                    } else if (theme === 'cyberpunk') {
                        root.classList.add('cyberpunk-theme');
                    }
                    
                    // 更新选中状态
                    themeOptions.forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 保存主题设置
                    localStorage.setItem('theme', theme);
                    
                    // 关闭主题菜单
                    themeMenu.classList.remove('active');
                    isThemeMenuOpen = false;
                });
            });
            
            // 预先激活音频上下文，解决一些浏览器要求用户交互才能播放音频的限制
            function initAudio() {
                // 创建一个静音的音频上下文
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 创建一个静音的音频元素
                const silentAudio = new Audio();
                silentAudio.volume = 0.01; // 几乎静音
                
                // 当用户首次与页面交互时，播放静音音频并加载语音合成
                document.body.addEventListener('click', function audioInitializer() {
                    // 播放静音音频
                    silentAudio.play().catch(e => console.log('静音音频初始化失败，这是正常的'));
                    
                    // 激活语音合成
                    if ('speechSynthesis' in window) {
                        window.speechSynthesis.speak(new SpeechSynthesisUtterance(''));
                    }
                    
                    // 移除事件监听器，只需执行一次
                    document.body.removeEventListener('click', audioInitializer);
                    
                    console.log('音频上下文已初始化');
                }, { once: true });
            }
            
            // 初始化音频环境
            initAudio();
            
            // 从localStorage获取已保存的数据
            function loadFromLocalStorage() {
                try {
                    // 获取已显示的单词列表
                    const savedShownWords = localStorage.getItem('vocabularyShownWords');
                    if (savedShownWords) {
                        shownWords = JSON.parse(savedShownWords);
                    }
                    
                    // 获取当前显示的单词
                    const savedCurrentWords = localStorage.getItem('vocabularyCurrentWords');
                    if (savedCurrentWords) {
                        return JSON.parse(savedCurrentWords);
                    }
                } catch (error) {
                    console.error('从本地存储加载失败:', error);
                }
                return null;
            }
            
            // 保存数据到localStorage
            function saveToLocalStorage() {
                try {
                    localStorage.setItem('vocabularyShownWords', JSON.stringify(shownWords));
                    localStorage.setItem('vocabularyCurrentWords', JSON.stringify(currentDisplayedWords));
                } catch (error) {
                    console.error('保存到本地存储失败:', error);
                }
            }
            
            // 显示单词列表
            function displayWords(words, saveToStorage = true) {
                const wordList = document.getElementById('wordList');
                if (!wordList) {
                    console.error('找不到wordList元素');
                    return;
                }
                
                wordList.innerHTML = '';
                words.forEach(word => {
                    const wordCard = createWordCard(word);
                    wordList.appendChild(wordCard);
                });
                
                // 仅当需要保存时更新当前显示的单词
                if (saveToStorage) {
                    currentDisplayedWords = words;
                    saveToLocalStorage();
                }
            }
            
            // 显示随机50个单词，不重复直到全部展示过
            function showRandomWords(forceUpdate = false) {
                // 只有当强制更新时才重新选择单词
                if (!forceUpdate) {
                    // 如果不是强制更新，并且已经有单词显示，则保持不变
                    if (currentDisplayedWords.length > 0) {
                        displayWords(currentDisplayedWords);
                        return;
                    }
                }
                
                // 如果没有单词数据，则返回
                if (!allWords || allWords.length === 0) {
                    console.error('尝试显示随机单词，但allWords为空');
                    return;
                }
                
                // 如果shownWords已经包含了所有单词，则重置
                if (shownWords.length >= allWords.length) {
                    shownWords = [];
                }
                
                // 过滤出未展示过的单词
                const notShownWords = allWords.filter(word => 
                    !shownWords.includes(word.word)
                );
                
                // 随机选择单词
                let selectedWords = [];
                
                // 如果未展示的单词超过50个，从中随机选择50个
                if (notShownWords.length >= 50) {
                    const shuffled = [...notShownWords].sort(() => 0.5 - Math.random());
                    selectedWords = shuffled.slice(0, 50);
                } 
                // 如果未展示的单词不足50个，使用所有未展示的单词，并从之前已展示的单词中补充
                else {
                    selectedWords = [...notShownWords];
                    
                    // 需要补充的单词数量
                    const needMore = 50 - notShownWords.length;
                    
                    if (needMore > 0 && allWords.length >= 50) {
                        // 从已展示过的单词中随机选择补充
                        const previouslyShown = allWords.filter(word => 
                            shownWords.includes(word.word)
                        );
                        
                        const shuffledPrevious = [...previouslyShown].sort(() => 0.5 - Math.random());
                        selectedWords = [...selectedWords, ...shuffledPrevious.slice(0, needMore)];
                    }
                }
                
                // 更新已展示单词记录 - 使用单词的原始大小写形式
                notShownWords.forEach(word => {
                    if (!shownWords.includes(word.word)) {
                        shownWords.push(word.word);
                    }
                });
                
                // 显示选中的单词并保存
                displayWords(selectedWords, true);
            }
            
            // 搜索功能
            const searchBtn = document.getElementById('searchBtn');
            const randomBtn = document.getElementById('randomBtn');
            const wordList = document.getElementById('wordList');
            const searchInput = document.getElementById('searchInput');
            
            // 搜索按钮点击事件
            if (searchBtn) {
                searchBtn.addEventListener('click', performSearch);
            }

            // 搜索输入框回车事件
            if (searchInput) {
                searchInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        performSearch();
                    }
                });
            }

            // 随机按钮点击事件
            if (randomBtn) {
                randomBtn.addEventListener('click', function() {
                    showRandomWords(true);
                });
            }
            
            // 执行搜索的函数
            function performSearch() {
                const searchTerm = searchInput.value.trim();
                const caseSensitive = document.getElementById('caseSensitiveCheckbox').checked;
                
                if (searchTerm !== '') {
                    // 根据复选框状态决定是否区分大小写
                    fetch(`/search_words?term=${encodeURIComponent(searchTerm)}&case_sensitive=${caseSensitive}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.words && data.words.length > 0) {
                                // 搜索结果不保存到currentDisplayedWords中
                                displayWords(data.words, false);
                            } else {
                                // 如果没有找到单词，显示添加单词的弹窗
                                showAddWordModal(searchTerm);
                            }
                        })
                        .catch(error => {
                            console.error('搜索请求失败:', error);
                            showNotification('搜索请求失败，请重试', 'error');
                        });
                } else {
                    // 如果搜索框为空，恢复显示当前的固定单词
                    displayWords(currentDisplayedWords);
                }
            }
            
            // 获取单词数据 - 放在DOMContentLoaded事件内的最后，确保前面的函数都已定义
            fetch('/get_words')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data.words) {
                        console.error('API返回的数据中没有words字段:', data);
                        return;
                    }
                    
                    allWords = data.words;
                    console.log(`成功加载了 ${allWords.length} 个单词`);
                    
                    // 尝试从本地存储中恢复当前显示的单词
                    const savedWords = loadFromLocalStorage();
                    
                    if (savedWords && savedWords.length > 0) {
                        // 验证保存的单词在当前词库中存在
                        const wordMap = {};
                        allWords.forEach(word => {
                            wordMap[word.word] = word;
                        });
                        
                        // 过滤出有效的单词
                        const validSavedWords = savedWords.filter(word => wordMap[word.word]);
                        
                        if (validSavedWords.length > 0) {
                            // 如果有有效的保存单词，使用它们
                            currentDisplayedWords = validSavedWords;
                            displayWords(currentDisplayedWords);
                            console.log('从本地存储恢复了', validSavedWords.length, '个单词');
                            return;
                        }
                    }
                    
                    // 如果没有有效的保存数据，随机选择新单词
                    showRandomWords(true);
                })
                .catch(error => {
                    console.error('获取单词数据失败:', error);
                });

            // 创建单词卡片
            function createWordCard(word) {
                // 处理多个词性和含义
                const processTranslation = (translation) => {
                    // 检查是否有多个词性和含义
                    const partsOfSpeech = [];
                    const meanings = [];
                    
                    // 拆分单词的翻译内容，支持多个词性
                    // 例如："vt.丢弃；放弃，抛弃" 或 "n.摘要 a.抽象的"
                    
                    // 优化处理连续词性的情况，如 "vi.交谈 vt.谈论"
                    translation = translation.replace(/([a-z]+\.)\s+([a-z]+\.)/g, '$1|$2');
                    
                    // 首先尝试按空格和词性分隔符切分
                    const posPattern = /([a-z]+\.)/g; // 匹配词性如 n. vt. adj. 等
                    let matches = translation.match(posPattern);
                    
                    if (matches && matches.length > 0) {
                        // 有词性标记，按词性分段
                        // 使用更复杂的分割方法，处理多个词性
                        let segments = [];
                        let lastIndex = 0;
                        let match;
                        
                        // 重置正则表达式
                        posPattern.lastIndex = 0;
                        
                        // 逐个找出所有词性标记的位置
                        while ((match = posPattern.exec(translation)) !== null) {
                            if (match.index > lastIndex) {
                                // 如果当前词性标记前有内容（上一个词性的含义）
                                segments.push(translation.substring(lastIndex, match.index).trim());
                            }
                            // 添加词性标记
                            segments.push(match[0]);
                            lastIndex = match.index + match[0].length;
                        }
                        
                        // 添加最后一部分
                        if (lastIndex < translation.length) {
                            segments.push(translation.substring(lastIndex).trim());
                        }
                        
                        // 过滤空字符串
                        segments = segments.filter(s => s.trim());
                        
                        // 恢复被替换的分隔符
                        segments = segments.map(s => s.replace(/\|/g, ' '));
                        
                        // 重组词性和对应的含义
                        for (let i = 0; i < segments.length; i++) {
                            if (segments[i].match(/^[a-z]+\.$/)) {
                                // 这是词性
                                const pos = segments[i];
                                // 下一个元素应该是含义
                                if (i + 1 < segments.length && !segments[i + 1].match(/^[a-z]+\.$/)) {
                                    // 有对应的含义
                                    let meaning = segments[i + 1];
                                    
                                    // 处理含义中的分号分隔的多个解释
                                    if (meaning.includes('；')) {
                                        // 将分号替换为逗号，保持同一词性的含义在同一行
                                        meaning = meaning.replace(/；/g, '，');
                                        partsOfSpeech.push(pos);
                                        meanings.push(meaning.trim());
                                    } else {
                                        partsOfSpeech.push(pos);
                                        meanings.push(meaning.trim());
                                    }
                                    
                                    i++; // 跳过已处理的含义
                                } else {
                                    // 没有对应的含义，可能是格式问题
                                    partsOfSpeech.push(pos);
                                    meanings.push('');
                                }
                            } else if (!segments[i].match(/^[a-z]+\.$/)) {
                                // 这是没有词性标记的含义，可能是翻译格式不规范
                                partsOfSpeech.push('');
                                meanings.push(segments[i].trim());
                            }
                        }
                    } else {
                        // 没有找到词性标记，尝试其他方式分割
                        // 检查是否包含分号，表示多个含义
                        if (translation.includes('；')) {
                            const parts = translation.split('；');
                            // 检查第一部分是否包含词性
                            const firstPart = parts[0];
                            const dotIndex = firstPart.indexOf('.');
                            
                            if (dotIndex > 0 && dotIndex < 5) {
                                // 有词性标记
                                const pos = firstPart.substring(0, dotIndex + 1);
                                const firstMeaning = firstPart.substring(dotIndex + 1).trim();
                                
                                // 将所有含义合并为一个，用逗号分隔
                                let allMeanings = firstMeaning;
                                for (let i = 1; i < parts.length; i++) {
                                    allMeanings += '，' + parts[i].trim();
                                }
                                
                                partsOfSpeech.push(pos);
                                meanings.push(allMeanings);
                            } else {
                                // 没有词性标记，全部作为含义
                                partsOfSpeech.push('');
                                meanings.push(translation);
                            }
                        } else {
                            // 没有分号，检查是否有词性标记
                            const dotIndex = translation.indexOf('.');
                            if (dotIndex > 0 && dotIndex < 5) {
                                // 有词性标记
                                partsOfSpeech.push(translation.substring(0, dotIndex + 1));
                                meanings.push(translation.substring(dotIndex + 1).trim());
                            } else {
                                // 没有词性标记，全部作为含义
                                partsOfSpeech.push('');
                                meanings.push(translation);
                            }
                        }
                    }
                    
                    // 如果没有识别出任何词性和含义，返回原始翻译
                    if (partsOfSpeech.length === 0) {
                        return [{
                            partOfSpeech: '',
                            meaning: translation
                        }];
                    }
                    
                    // 合并相同词性的含义
                    const result = [];
                    let currentPos = '';
                    let currentMeanings = [];
                    
                    for (let i = 0; i < partsOfSpeech.length; i++) {
                        if (partsOfSpeech[i] && partsOfSpeech[i] !== currentPos) {
                            // 新的词性开始，先保存之前的结果
                            if (currentPos && currentMeanings.length > 0) {
                                result.push({
                                    partOfSpeech: currentPos,
                                    meaning: currentMeanings.join('，')
                                });
                                currentMeanings = [];
                            }
                            
                            // 更新当前词性
                            currentPos = partsOfSpeech[i];
                            currentMeanings.push(meanings[i]);
                        } else if (partsOfSpeech[i] === currentPos) {
                            // 相同词性，添加到当前含义列表
                            currentMeanings.push(meanings[i]);
                        } else if (!partsOfSpeech[i] && currentPos) {
                            // 没有词性但属于前一个词性
                            currentMeanings.push(meanings[i]);
                        } else {
                            // 完全没有词性的情况
                            if (currentPos && currentMeanings.length > 0) {
                                // 保存之前的结果
                                result.push({
                                    partOfSpeech: currentPos,
                                    meaning: currentMeanings.join('，')
                                });
                                currentMeanings = [];
                                currentPos = '';
                            }
                            
                            // 添加无词性的含义
                            result.push({
                                partOfSpeech: '',
                                meaning: meanings[i]
                            });
                        }
                    }
                    
                    // 添加最后一组
                    if (currentPos && currentMeanings.length > 0) {
                        result.push({
                            partOfSpeech: currentPos,
                            meaning: currentMeanings.join('，')
                        });
                    }
                    
                    return result;
                };
                
                // 处理单词的翻译
                const parsedTranslations = processTranslation(word.translation);
                
                // 创建卡片
                const card = document.createElement('div');
                card.className = 'word-card';
                
                // 创建朗读按钮的函数
                const createPronunciationBtn = () => {
                    const btn = document.createElement('button');
                    btn.className = 'pronunciation-btn';
                    btn.title = '朗读';
                    btn.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                            <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                            <path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path>
                        </svg>
                    `;
                    
                    // 使用事件监听器而不是内联onclick，避免引号转义问题
                    btn.addEventListener('click', (event) => {
                        event.stopPropagation(); // 阻止事件冒泡
                        speakWord(word.word);
                    });
                    
                    return btn;
                };
                
                // 创建卡片内容
                const frontSide = document.createElement('div');
                frontSide.className = 'word-front';
                
                const wordText = document.createElement('h3');
                wordText.className = 'word-text';
                wordText.textContent = word.word;
                
                const wordDetails = document.createElement('div');
                wordDetails.className = 'word-details';
                
                // 添加每个词性和含义
                parsedTranslations.forEach((item, index) => {
                    const entryContainer = document.createElement('div');
                    entryContainer.className = 'translation-entry';
                    
                    // 如果有词性，显示词性
                    if (item.partOfSpeech) {
                        const posSpan = document.createElement('span');
                        posSpan.className = 'part-of-speech';
                        posSpan.textContent = item.partOfSpeech;
                        entryContainer.appendChild(posSpan);
                    }
                    
                    const meaningP = document.createElement('p');
                    meaningP.className = 'word-meaning';
                    meaningP.textContent = item.meaning;
                    entryContainer.appendChild(meaningP);
                    
                    wordDetails.appendChild(entryContainer);
                });
                
                // 如果有level属性，添加显示
                if (word.level) {
                    const levelSpan = document.createElement('span');
                    levelSpan.className = 'word-level';
                    levelSpan.textContent = word.level;
                    wordDetails.appendChild(levelSpan);
                }
                
                // 组装前面
                frontSide.appendChild(wordText);
                frontSide.appendChild(createPronunciationBtn());
                frontSide.appendChild(wordDetails);
                
                // 创建背面
                const backSide = document.createElement('div');
                backSide.className = 'word-back';
                
                const wordDetailsBack = document.createElement('div');
                wordDetailsBack.className = 'word-details-back';
                
                const wordTextBack = document.createElement('h3');
                wordTextBack.className = 'word-text';
                wordTextBack.textContent = word.word;
                
                // 添加每个词性和含义到背面
                parsedTranslations.forEach((item, index) => {
                    const entryContainer = document.createElement('div');
                    entryContainer.className = 'translation-entry';
                    
                    // 如果有词性，显示词性
                    if (item.partOfSpeech) {
                        const posSpanBack = document.createElement('span');
                        posSpanBack.className = 'part-of-speech';
                        posSpanBack.textContent = item.partOfSpeech;
                        entryContainer.appendChild(posSpanBack);
                    }
                    
                    const meaningPBack = document.createElement('p');
                    meaningPBack.className = 'word-meaning';
                    meaningPBack.textContent = item.meaning;
                    entryContainer.appendChild(meaningPBack);
                    
                    wordDetailsBack.appendChild(entryContainer);
                });
                
                // 如果有level属性，添加显示到背面
                if (word.level) {
                    const levelSpanBack = document.createElement('span');
                    levelSpanBack.className = 'word-level';
                    levelSpanBack.textContent = word.level;
                    wordDetailsBack.appendChild(levelSpanBack);
                }
                
                // 组装背面
                wordDetailsBack.insertBefore(wordTextBack, wordDetailsBack.firstChild);
                wordDetailsBack.insertBefore(createPronunciationBtn(), wordDetailsBack.firstChild.nextSibling);
                backSide.appendChild(wordDetailsBack);
                
                // 组装卡片
                card.appendChild(frontSide);
                card.appendChild(backSide);
                
                // 点击卡片翻转
                card.addEventListener('click', function() {
                    this.classList.toggle('flipped');
                });
                
                return card;
            }

            // 朗读单词的函数
            function speakWord(word) {
                // 获取所有与这个单词相关的发音按钮
                const speakerButtons = document.querySelectorAll(`.pronunciation-btn[onclick*="${word}"]`);
                
                // 当开始朗读时改变按钮外观
                speakerButtons.forEach(btn => {
                    btn.classList.add('speaking');
                });
                
                // 尝试使用浏览器内置语音朗读
                if ('speechSynthesis' in window) {
                    try {
                        // 先停止之前可能正在进行的朗读
                        window.speechSynthesis.cancel();
                        
                        // 创建语音合成实例
                        const utterance = new SpeechSynthesisUtterance(word);
                        utterance.lang = 'en-US'; // 设置语言为英语
                        utterance.voice = findEnglishVoice(); // 尝试找到英语语音
                        utterance.rate = 0.9; // 语速稍微慢一点
                        utterance.volume = 1.0; // 确保音量足够
                        
                        // 当朗读结束时恢复按钮外观
                        utterance.onend = function() {
                            speakerButtons.forEach(btn => {
                                btn.classList.remove('speaking');
                            });
                        };
                        
                        // 处理朗读错误
                        utterance.onerror = function(event) {
                            console.error('浏览器朗读错误:', event);
                            // 如果浏览器朗读失败，尝试使用API朗读
                            useFallbackAudio(word, speakerButtons);
                        };
                        
                        // 开始朗读
                        window.speechSynthesis.speak(utterance);
                        console.log(`正在使用浏览器朗读: "${word}"`);
                    } catch (error) {
                        console.error('朗读出错:', error);
                        // 如果出错，使用备选朗读方式
                        useFallbackAudio(word, speakerButtons);
                    }
                } else {
                    // 如果浏览器不支持语音合成，使用备选朗读方式
                    console.log('浏览器不支持语音合成，使用备选方案');
                    useFallbackAudio(word, speakerButtons);
                }
            }
            
            // 使用服务器API朗读单词
            function useFallbackAudio(word, speakerButtons) {
                try {
                    // 创建音频元素
                    const audio = new Audio();
                    
                    // 使用直接返回音频的API端点
                    audio.src = `/get_pronunciation?word=${encodeURIComponent(word)}&t=${new Date().getTime()}`;
                    
                    // 设置音频事件处理
                    audio.onended = function() {
                        speakerButtons.forEach(btn => {
                            btn.classList.remove('speaking');
                        });
                        console.log('音频播放完成');
                    };
                    
                    audio.onerror = function(e) {
                        console.error('音频播放错误:', e);
                        speakerButtons.forEach(btn => {
                            btn.classList.remove('speaking');
                        });
                        
                        // 使用自定义通知显示错误信息
                        showNotification('无法播放发音', 'error', 3000);
                    };
                    
                    // 尝试播放音频
                    const playPromise = audio.play();
                    
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.error('音频播放Promise错误:', error);
                            speakerButtons.forEach(btn => {
                                btn.classList.remove('speaking');
                            });
                        });
                    }
                    
                    console.log(`正在使用API朗读: "${word}"`);
                } catch (error) {
                    console.error('音频创建或播放失败:', error);
                    speakerButtons.forEach(btn => {
                        btn.classList.remove('speaking');
                    });
                }
            }
            
            // 尝试查找英语语音
            function findEnglishVoice() {
                if (!window.speechSynthesis) return null;
                
                // 等待语音列表加载
                let voices = window.speechSynthesis.getVoices();
                if (voices.length === 0) {
                    // 在某些浏览器中，voices 可能需要一段时间才能加载
                    return null; // 将使用默认语音
                }
                
                // 优先查找英语（美国）语音
                let voice = voices.find(voice => /en-US/i.test(voice.lang) && voice.localService);
                
                // 如果没有找到英语（美国）语音，尝试查找任何英语语音
                if (!voice) {
                    voice = voices.find(voice => /en/i.test(voice.lang));
                }
                
                // 如果仍然没有找到，使用默认语音
                return voice || null;
            }
            
            // 确保语音列表加载
            if ('speechSynthesis' in window) {
                // Chrome 需要触发这个事件来加载语音
                speechSynthesis.onvoiceschanged = function() {
                    findEnglishVoice();
                };
                // 预加载语音
                speechSynthesis.getVoices();
            }

            // 显示添加单词的弹窗
            function showAddWordModal(word) {
                const modal = document.getElementById('addWordModal');
                const searchedWordSpan = document.getElementById('searchedWord');
                const wordInput = document.getElementById('wordInput');
                const translationInput = document.getElementById('translationInput');
                
                // 设置弹窗中的单词 - 保留原始输入的大小写
                searchedWordSpan.textContent = word;
                wordInput.value = word;
                translationInput.value = '';
                
                // 显示弹窗
                modal.style.display = 'flex';
            }
            
            // 关闭弹窗
            document.querySelector('.close-modal').addEventListener('click', function() {
                document.getElementById('addWordModal').style.display = 'none';
            });
            
            // 点击取消按钮关闭弹窗
            document.getElementById('cancelAddBtn').addEventListener('click', function() {
                document.getElementById('addWordModal').style.display = 'none';
            });
            
            // 点击模态框外部关闭模态框
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('addWordModal');
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            // 添加单词按钮点击事件
            document.getElementById('addWordBtn').addEventListener('click', function() {
                const wordInput = document.getElementById('wordInput');
                const translationInput = document.getElementById('translationInput');
                
                const word = wordInput.value.trim();
                const translation = translationInput.value.trim();
                
                if (!word) {
                    showNotification('请输入单词', 'warning');
                    return;
                }
                
                if (!translation) {
                    showNotification('请输入翻译', 'warning');
                    return;
                }
                
                // 发送添加单词的请求
                fetch('/add_word', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        word: word,
                        translation: translation
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 关闭弹窗
                        document.getElementById('addWordModal').style.display = 'none';
                        
                        // 显示成功消息
                        showNotification('单词已成功添加到单词库!', 'success');
                        
                        // 将新单词添加到allWords
                        const newWord = data.word;
                        allWords.push(newWord);
                        
                        // 显示包含这个新单词的单词卡片
                        displayWords([newWord], false);
                        
                        // 清空搜索框
                        searchInput.value = '';
                    } else {
                        showNotification('添加单词失败: ' + data.error, 'error');
                    }
                })
                .catch(error => {
                    console.error('添加单词请求失败:', error);
                    showNotification('添加单词请求失败，请重试', 'error');
                });
            });

            // 显示通知提示框
            function showNotification(message, type = 'info', duration = 3000) {
                // 创建通知元素
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                
                // 添加通知内容
                const content = document.createElement('div');
                content.className = 'notification-content';
                content.textContent = message;
                
                // 添加关闭按钮
                const closeBtn = document.createElement('span');
                closeBtn.className = 'notification-close';
                closeBtn.innerHTML = '&times;';
                closeBtn.addEventListener('click', () => {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                });
                
                // 组装通知
                notification.appendChild(content);
                notification.appendChild(closeBtn);
                document.body.appendChild(notification);
                
                // 设置自动关闭
                if (duration > 0) {
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            notification.classList.add('fade-out');
                            setTimeout(() => {
                                if (document.body.contains(notification)) {
                                    document.body.removeChild(notification);
                                }
                            }, 300);
                        }
                    }, duration);
                }
                
                return notification;
            }
        });
    </script>
</body>
</html> 